<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0C7C6D">
    <meta name="description" content="Assess and purify your spiritual heart with wisdom from classical Islamic scholars">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Qalb">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <title>Qalb - Spiritual Heart Health Assessment</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0C7C6D;
            --primary-light: #14A895;
            --primary-dark: #064E45;
            --gold: #D4AF37;
            --cream: #FBF8F3;
            --text: #1A1A1A;
            --text-light: #666;
            --white: #FFFFFF;
            --danger: #C53030;
            --warning: #DD6B20;
            --success: #38A169;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #E8E4DD 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(12, 124, 109, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(212, 175, 55, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 0.8s ease-out;
        }
        
        .logo {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: var(--text-light);
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        .arabic-subtitle {
            font-size: 1.5rem;
            color: var(--gold);
            margin-top: 15px;
            font-weight: 400;
        }
        
        .card {
            background: var(--white);
            border-radius: 24px;
            padding: 50px 60px;
            box-shadow: 
                0 10px 40px rgba(0,0,0,0.06),
                0 0 0 1px rgba(12, 124, 109, 0.05);
            animation: fadeInUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--gold), var(--primary));
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.2rem;
            color: var(--primary-dark);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .intro-text {
            text-align: center;
            margin-bottom: 40px;
            color: var(--text-light);
            line-height: 1.8;
            font-size: 1.05rem;
        }
        
        .bismillah {
            text-align: center;
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 30px;
            font-weight: 400;
        }
        
        .question {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(12, 124, 109, 0.1);
            animation: fadeIn 0.5s ease-out;
        }
        
        .question:last-child {
            border-bottom: none;
        }
        
        .question-text {
            font-size: 1.15rem;
            color: var(--text);
            margin-bottom: 20px;
            line-height: 1.6;
            font-weight: 500;
        }
        
        .question-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            margin-right: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .scenario {
            background: linear-gradient(135deg, rgba(12, 124, 109, 0.05), rgba(212, 175, 55, 0.05));
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-style: italic;
            border-left: 4px solid var(--gold);
        }
        
        .options {
            margin-top: 20px;
        }
        
        .option {
            background: white;
            border: 2px solid rgba(12, 124, 109, 0.2);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .option:hover {
            border-color: var(--primary);
            background: rgba(12, 124, 109, 0.05);
            transform: translateX(5px);
        }
        
        .option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(12, 124, 109, 0.1), rgba(212, 175, 55, 0.1));
            font-weight: 600;
        }
        
        .option-letter {
            display: inline-block;
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            margin-right: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .option.selected .option-letter {
            background: linear-gradient(135deg, var(--primary), var(--gold));
        }
        
        .slider-container {
            padding: 20px 0;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 10px;
            background: linear-gradient(to right, 
                var(--success) 0%, 
                var(--warning) 50%, 
                var(--danger) 100%);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 3px solid var(--primary);
            transition: transform 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 3px solid var(--primary);
        }
        
        .slider-value {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .progress-container {
            margin: 30px 0;
            background: rgba(12, 124, 109, 0.1);
            height: 6px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        .btn {
            display: inline-block;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 1.05rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 15px rgba(12, 124, 109, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(12, 124, 109, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            margin-right: 15px;
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 40px;
        }
        
        .results-header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .health-score {
            font-size: 5rem;
            font-weight: 700;
            font-family: 'Cormorant Garamond', serif;
            margin: 20px 0;
            background: linear-gradient(135deg, var(--primary), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .health-label {
            font-size: 1.5rem;
            color: var(--text-light);
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .heart-icon {
            font-size: 4rem;
            margin: 20px 0;
            animation: heartbeat 1.5s infinite;
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .category-card {
            background: linear-gradient(135deg, var(--white) 0%, var(--cream) 100%);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(12, 124, 109, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .category-name {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .category-score {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Cormorant Garamond', serif;
            margin: 10px 0;
        }
        
        .category-status {
            font-size: 0.9rem;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .status-excellent { background: var(--success); color: white; }
        .status-good { background: var(--primary); color: white; }
        .status-concerning { background: var(--warning); color: white; }
        .status-critical { background: var(--danger); color: white; }
        
        .prescription {
            background: linear-gradient(135deg, var(--white) 0%, var(--cream) 100%);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
            border-left: 6px solid var(--gold);
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            animation: slideIn 0.6s ease-out;
            animation-fill-mode: both;
        }
        
        .prescription:nth-child(1) { animation-delay: 0.1s; }
        .prescription:nth-child(2) { animation-delay: 0.2s; }
        .prescription:nth-child(3) { animation-delay: 0.3s; }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .prescription-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.2);
        }
        
        .prescription-icon {
            font-size: 2.5rem;
            margin-right: 15px;
        }
        
        .prescription-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
            color: var(--primary-dark);
            font-weight: 700;
        }
        
        .prescription-arabic {
            color: var(--gold);
            font-size: 1.3rem;
            margin-top: 5px;
        }
        
        .prescription-section {
            margin: 20px 0;
        }
        
        .prescription-section-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .prescription-content {
            color: var(--text);
            line-height: 1.8;
            font-size: 1.05rem;
        }
        
        .power-reminder {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            font-style: italic;
            font-size: 1.1rem;
            line-height: 1.6;
            box-shadow: 0 4px 15px rgba(12, 124, 109, 0.2);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .card {
                padding: 30px 25px;
            }
            
            .logo {
                font-size: 2.2rem;
            }
            
            h2 {
                font-size: 1.8rem;
            }
            
            .health-score {
                font-size: 3.5rem;
            }
            
            .categories-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0 !important;
            }
        }
        
        .phase-transition {
            text-align: center;
            padding: 40px;
            animation: fadeIn 1s ease;
        }
        
        .phase-transition h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .phase-transition p {
            color: var(--text-light);
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 15px;
        }
        
        .flagged-categories {
            margin: 30px 0;
        }
        
        .flagged-category-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--warning), var(--danger));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin: 5px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">QALB</div>
            <div class="subtitle">Spiritual Heart Health Assessment</div>
            <div class="arabic-subtitle">ÿ™ŸÇŸäŸäŸÖ ÿµÿ≠ÿ© ÿßŸÑŸÇŸÑÿ® ÿßŸÑÿ±Ÿàÿ≠Ÿä</div>
        </header>

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="card">
            <div class="bismillah">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸíŸÖŸê</div>
            <h2>Discover the State of Your Heart</h2>
            <div class="intro-text">
                <p style="margin-bottom: 20px;">
                    "Indeed, there is in the body a piece of flesh which, if sound, the entire body is sound, 
                    and if corrupt, the entire body is corrupt. Verily, it is the heart."
                    <br><em style="color: var(--gold);">‚Äî Prophet Muhammad Ô∑∫</em>
                </p>
                <p style="margin-bottom: 20px;">
                    This adaptive assessment uses <strong>real-life scenarios</strong> combined with the wisdom of 
                    <strong>Ahmad Zarruq</strong> and <strong>Imam Mawlud</strong> to help you identify and treat spiritual diseases.
                </p>
                <p style="color: var(--primary); font-weight: 500;">
                    Phase 1: 18 situational questions (~10 minutes)<br>
                    Phase 2: Adaptive deep dive if needed (~10 more minutes)<br>
                    Privacy: Your answers stay private on your device
                </p>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="startAssessment()">Begin Assessment</button>
            </div>
        </div>

        <!-- Phase 1: Category Screening -->
        <div id="phase1-screen" class="card hidden">
            <h2>Phase 1: Situational Screening</h2>
            <div class="progress-container">
                <div id="progress-bar-phase1" class="progress-bar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progress-text-phase1">Question 1 of 18</div>
            
            <div id="questions-phase1"></div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="goBackPhase1()" id="back-btn-phase1" style="display:none;">Back</button>
                <button class="btn btn-primary" onclick="nextPhase1()" id="next-btn-phase1" disabled>Next</button>
            </div>
        </div>

        <!-- Phase Transition -->
        <div id="transition-screen" class="card hidden">
            <div class="phase-transition">
                <h3>üìä Phase 1 Complete!</h3>
                <p>Based on your responses, we've identified some areas that need deeper attention:</p>
                <div class="flagged-categories" id="flagged-list"></div>
                <p style="margin-top: 30px;">Phase 2 will ask <strong>5 targeted questions</strong> for each flagged area to identify specific diseases and provide precise prescriptions.</p>
                <p style="color: var(--gold); font-weight: 600;">This will take approximately 10 more minutes.</p>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="startPhase2()">Continue to Phase 2</button>
            </div>
        </div>

        <!-- Phase 2: Deep Dive -->
        <div id="phase2-screen" class="card hidden">
            <h2>Phase 2: Deep Dive Assessment</h2>
            <div class="progress-container">
                <div id="progress-bar-phase2" class="progress-bar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progress-text-phase2"></div>
            
            <div id="questions-phase2"></div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="goBackPhase2()">Back</button>
                <button class="btn btn-primary" onclick="nextPhase2()" id="next-btn-phase2" disabled>Next</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="card hidden">
            <div class="results-header">
                <h2>Your Spiritual Heart Health Report</h2>
                <div class="health-label">Overall Heart Health</div>
                <div class="health-score" id="overall-score">85%</div>
                <div class="heart-icon">‚ù§Ô∏è</div>
                <div id="health-description" style="color: var(--text-light); font-size: 1.1rem; margin-top: 10px;"></div>
            </div>

            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--primary-dark); margin: 40px 0 20px 0; text-align: center;">
                Category Breakdown
            </h3>
            <div id="categories-results" class="categories-grid"></div>

            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--primary-dark); margin: 60px 0 30px 0; text-align: center;">
                Your Personalized Prescriptions
            </h3>
            <div id="prescriptions-container"></div>

            <div class="button-group" style="margin-top: 50px;">
                <button class="btn btn-secondary" onclick="retakeAssessment()">Retake Assessment</button>
                <button class="btn btn-primary" onclick="saveResults()">Save Results</button>
            </div>
        </div>
    </div>

    <!-- Install PWA Banner -->
    <div id="install-banner" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #0C7C6D, #14A895); color: white; padding: 15px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10000; animation: slideUp 0.5s ease;">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center;">
            <span style="font-weight: 600;">üì± Install Qalb App!</span>
            <button onclick="installPWA()" style="background: white; color: #0C7C6D; border: none; padding: 8px 20px; border-radius: 25px; font-weight: 600; cursor: pointer;">Install</button>
            <button onclick="dismissInstallBanner()" style="background: transparent; color: white; border: 2px solid white; padding: 8px 20px; border-radius: 25px; font-weight: 600; cursor: pointer;">Later</button>
        </div>
    </div>

    <style>
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @media (max-width: 768px) {
            #install-banner { left: 10px; right: 10px; transform: none; width: auto; }
            #install-banner > div { flex-direction: column; gap: 10px; }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // QUESTION DATABASE
        const PHASE1_QUESTIONS = [
            // Category 1: Wealth (Q1-3)
            {
                id: 1,
                category: 'wealth',
                type: 'multiple',
                scenario: 'You receive your salary and see an urgent appeal for people suffering in Gaza. What do you normally do?',
                options: [
                    { letter: 'A', text: 'Skip it immediately', score: 4 },
                    { letter: 'B', text: "Think 'I'll donate later' but usually forget", score: 3 },
                    { letter: 'C', text: 'Feel frustrated by these constant appeals', score: 3 },
                    { letter: 'D', text: "Feel guilty but don't act", score: 2 },
                    { letter: 'E', text: 'Donate something, even if small', score: 1 },
                    { letter: 'F', text: 'Go directly and give charity with gratitude', score: 0 }
                ]
            },
            {
                id: 2,
                category: 'wealth',
                type: 'multiple',
                scenario: "You're at a restaurant with friends. The bill comes and it's higher than expected. Your first thought is:",
                options: [
                    { letter: 'A', text: 'Worry about your bank balance even though you can afford it', score: 4 },
                    { letter: 'B', text: 'Calculate exactly your share to avoid paying extra', score: 3 },
                    { letter: 'C', text: 'Frustrated you have to spend this much', score: 3 },
                    { letter: 'D', text: 'Fine with it but hope someone else offers to pay', score: 2 },
                    { letter: 'E', text: 'Split it fairly without stress', score: 1 },
                    { letter: 'F', text: 'Offer to pay for everyone as sadaqah', score: 0 }
                ]
            },
            {
                id: 3,
                category: 'wealth',
                type: 'multiple',
                scenario: 'A colleague shows you their new car/phone/house. Your immediate reaction is:',
                options: [
                    { letter: 'A', text: 'Intensely wish you had it instead', score: 4 },
                    { letter: 'B', text: 'Calculate how you can afford the same', score: 4 },
                    { letter: 'C', text: 'Feel inadequate about what you have', score: 3 },
                    { letter: 'D', text: "Wonder why they have it and you don't", score: 3 },
                    { letter: 'E', text: 'Happy for them, neutral about yourself', score: 1 },
                    { letter: 'F', text: 'Happy for them, grateful for what you have', score: 0 }
                ]
            },
            // Category 2: Self (Q4-6)
            {
                id: 4,
                category: 'self',
                type: 'multiple',
                scenario: 'Someone points out a mistake you made publicly. Your instant reaction is:',
                options: [
                    { letter: 'A', text: "Become defensive and argue why you're right", score: 4 },
                    { letter: 'B', text: 'Make excuses or blame circumstances', score: 3 },
                    { letter: 'C', text: 'Feel embarrassed and get angry inside', score: 3 },
                    { letter: 'D', text: 'Dismiss it quietly but hold grudge', score: 2 },
                    { letter: 'E', text: 'Feel bad but accept it', score: 1 },
                    { letter: 'F', text: 'Thank them and immediately correct it', score: 0 }
                ]
            },
            {
                id: 5,
                category: 'self',
                type: 'multiple',
                scenario: 'You help someone significantly but nobody knows about it. How do you feel?',
                options: [
                    { letter: 'A', text: 'Frustrated that no one saw it', score: 4 },
                    { letter: 'B', text: "Tempted to mention it 'casually' to others", score: 3 },
                    { letter: 'C', text: 'Hope they at least tell others about it', score: 3 },
                    { letter: 'D', text: 'Wish someone had witnessed it', score: 2 },
                    { letter: 'E', text: 'Content, though slight wish for recognition', score: 1 },
                    { letter: 'F', text: 'Pure satisfaction between you and Allah', score: 0 }
                ]
            },
            {
                id: 6,
                category: 'self',
                type: 'multiple',
                scenario: "You're mistreated by a security guard/cleaner/service worker for no reason. What do you do?",
                options: [
                    { letter: 'A', text: 'Use your position/power to retaliate', score: 4 },
                    { letter: 'B', text: 'Complain to their superior to get them in trouble', score: 3 },
                    { letter: 'C', text: 'Argue and make them feel small', score: 3 },
                    { letter: 'D', text: 'Feel angry, complain to friends later', score: 2 },
                    { letter: 'E', text: 'Let it go, but feel upset inside', score: 1 },
                    { letter: 'F', text: 'Respond with patience and kindness', score: 0 }
                ]
            },
            // Category 3: Relationships (Q7-9)
            {
                id: 7,
                category: 'relationships',
                type: 'multiple',
                scenario: 'Your friend calls excitedly - they got a job with 4x your salary. Your instant gut feeling is:',
                options: [
                    { letter: 'A', text: 'Why do they get it and not me?', score: 4 },
                    { letter: 'B', text: "Wishing they'd lose it somehow", score: 4 },
                    { letter: 'C', text: "Complaining to Allah 'Why not me?'", score: 3 },
                    { letter: 'D', text: 'Happy for them but bitter inside', score: 3 },
                    { letter: 'E', text: 'Happy but comparing yourself', score: 2 },
                    { letter: 'F', text: "Genuinely happy and make du'a for them", score: 0 }
                ]
            },
            {
                id: 8,
                category: 'relationships',
                type: 'multiple',
                scenario: 'Someone wronged you badly 2 years ago. They never apologized. You run into them today. Your reaction:',
                options: [
                    { letter: 'A', text: 'Ignore them completely, hold the grudge', score: 4 },
                    { letter: 'B', text: 'Be cold and make them feel your anger', score: 3 },
                    { letter: 'C', text: 'Replay what they did and get angry again', score: 3 },
                    { letter: 'D', text: 'Polite but secretly hope they suffer', score: 2 },
                    { letter: 'E', text: 'Civil but not warm', score: 1 },
                    { letter: 'F', text: 'Greet warmly, already forgiven them', score: 0 }
                ]
            },
            {
                id: 9,
                category: 'relationships',
                type: 'multiple',
                scenario: "Friends are talking about someone's mistakes/scandals. You:",
                options: [
                    { letter: 'A', text: 'Jump in with more details you know', score: 4 },
                    { letter: 'B', text: 'Listen intently and enjoy the story', score: 3 },
                    { letter: 'C', text: 'Stay quiet but interested', score: 2 },
                    { letter: 'D', text: "Feel uncomfortable but don't say anything", score: 2 },
                    { letter: 'E', text: 'Change subject subtly', score: 1 },
                    { letter: 'F', text: 'Stop it immediately or leave', score: 0 }
                ]
            },
            // Category 4: Desires (Q10-12)
            {
                id: 10,
                category: 'desires',
                type: 'multiple',
                scenario: "You're alone with your phone/computer. Temptation to watch something inappropriate arises. You:",
                options: [
                    { letter: 'A', text: 'Give in immediately without resistance', score: 4 },
                    { letter: 'B', text: 'Try to resist but usually fail', score: 3 },
                    { letter: 'C', text: 'Struggle but eventually give in', score: 3 },
                    { letter: 'D', text: 'Resist but keep thinking about it', score: 2 },
                    { letter: 'E', text: 'Distract yourself successfully most times', score: 1 },
                    { letter: 'F', text: 'Immediately close/avoid and seek refuge in Allah', score: 0 }
                ]
            },
            {
                id: 11,
                category: 'desires',
                type: 'multiple',
                scenario: "It's Fajr time. Your alarm goes off. Bed is warm and comfortable. You:",
                options: [
                    { letter: 'A', text: 'Turn off alarm, sleep through', score: 4 },
                    { letter: 'B', text: 'Snooze repeatedly, miss it usually', score: 3 },
                    { letter: 'C', text: 'Internal battle, miss it 50% of time', score: 3 },
                    { letter: 'D', text: 'Force yourself up but feel resentful', score: 2 },
                    { letter: 'E', text: 'Get up but struggle every time', score: 1 },
                    { letter: 'F', text: 'Jump up immediately with gratitude', score: 0 }
                ]
            },
            {
                id: 12,
                category: 'desires',
                type: 'multiple',
                scenario: 'Someone mentions death or you see a funeral. Your immediate reaction is:',
                options: [
                    { letter: 'A', text: 'Actively avoid thinking about it', score: 4 },
                    { letter: 'B', text: 'Get anxious and change the subject', score: 3 },
                    { letter: 'C', text: 'Uncomfortable, try to distract yourself', score: 3 },
                    { letter: 'D', text: 'Brief moment of reflection then forget', score: 2 },
                    { letter: 'E', text: 'Reflect but then return to normal', score: 1 },
                    { letter: 'F', text: 'Deep reflection and check your actions', score: 0 }
                ]
            },
            // Category 5: Allah (Q13-15)
            {
                id: 13,
                category: 'allah',
                type: 'multiple',
                scenario: "You're in the middle of Salah. Your mind:",
                options: [
                    { letter: 'A', text: "Completely elsewhere, barely aware you're praying", score: 4 },
                    { letter: 'B', text: 'Mostly thinking about dunya matters', score: 3 },
                    { letter: 'C', text: 'Trying to focus but constantly distracted', score: 2 },
                    { letter: 'D', text: 'Some presence, some distraction', score: 2 },
                    { letter: 'E', text: 'Mostly present with occasional drift', score: 1 },
                    { letter: 'F', text: 'Fully present with Allah', score: 0 }
                ]
            },
            {
                id: 14,
                category: 'allah',
                type: 'multiple',
                scenario: 'You face a major setback - job loss, illness, or rejection. Your first thought is:',
                options: [
                    { letter: 'A', text: 'Why is Allah doing this to me?', score: 4 },
                    { letter: 'B', text: "I don't deserve this, Allah is unfair", score: 4 },
                    { letter: 'C', text: 'What did I do to deserve this? (Blaming)', score: 3 },
                    { letter: 'D', text: 'Complaining to everyone about your bad luck', score: 3 },
                    { letter: 'E', text: 'Sad but trying to accept', score: 2 },
                    { letter: 'F', text: "Alhamdulillah, trust Allah's wisdom", score: 0 }
                ]
            },
            {
                id: 15,
                category: 'allah',
                type: 'multiple',
                scenario: 'Crisis hits. You need urgent help. Your first instinct is to:',
                options: [
                    { letter: 'A', text: 'Call people for help immediately', score: 4 },
                    { letter: 'B', text: 'Panic and think who can help me', score: 3 },
                    { letter: 'C', text: 'Try to fix it yourself first', score: 3 },
                    { letter: 'D', text: "Ask people then remember Allah", score: 2 },
                    { letter: 'E', text: "Make quick du'a then take action", score: 1 },
                    { letter: 'F', text: 'Turn to Allah first, then use means', score: 0 }
                ]
            },
            // Category 6: Emotional (Q16-18)
            {
                id: 16,
                category: 'emotional',
                type: 'multiple',
                scenario: 'Someone cuts you off in traffic or pushes you in line rudely. You:',
                options: [
                    { letter: 'A', text: 'Explode immediately with anger/curse', score: 4 },
                    { letter: 'B', text: 'Get very angry, confront them aggressively', score: 3 },
                    { letter: 'C', text: 'Angry inside, make hostile gestures', score: 3 },
                    { letter: 'D', text: 'Annoyed, mutter complaints', score: 2 },
                    { letter: 'E', text: 'Frustrated but stay calm outwardly', score: 1 },
                    { letter: 'F', text: 'Remain calm, assume good reason', score: 0 }
                ]
            },
            {
                id: 17,
                category: 'emotional',
                type: 'multiple',
                scenario: 'You wake up Monday morning. First thoughts about the day ahead are:',
                options: [
                    { letter: 'A', text: 'This day will be terrible', score: 4 },
                    { letter: 'B', text: 'Here we go again, same problems', score: 3 },
                    { letter: 'C', text: 'Worried about what might go wrong', score: 3 },
                    { letter: 'D', text: 'Neutral, taking it as it comes', score: 2 },
                    { letter: 'E', text: 'Hopeful but cautious', score: 1 },
                    { letter: 'F', text: 'Grateful for a new day, optimistic', score: 0 }
                ]
            },
            {
                id: 18,
                category: 'emotional',
                type: 'multiple',
                scenario: 'Discussion with someone who disagrees with you. You:',
                options: [
                    { letter: 'A', text: 'Must win at all costs, get aggressive', score: 4 },
                    { letter: 'B', text: "Argue intensely, can't let them be right", score: 3 },
                    { letter: 'C', text: 'Keep pushing your point repeatedly', score: 3 },
                    { letter: 'D', text: 'Debate but willing to stop if needed', score: 2 },
                    { letter: 'E', text: 'Discuss to understand, not to win', score: 1 },
                    { letter: 'F', text: 'Listen genuinely, willing to be wrong', score: 0 }
                ]
            }
        ];

        const CATEGORIES = {
            wealth: { name: 'Wealth & Provision', nameAr: 'ÿßŸÑŸÖŸéÿßŸÑ ŸàŸéÿßŸÑÿ±ŸêŸëÿ≤ŸíŸÇ' },
            self: { name: 'Self & Ego', nameAr: 'ÿßŸÑŸÜŸéŸëŸÅŸíÿ≥' },
            relationships: { name: 'Relationships', nameAr: 'ÿßŸÑŸÜŸéŸëÿßÿ≥' },
            desires: { name: 'Desires & Appetites', nameAr: 'ÿßŸÑÿ¥ŸéŸëŸáŸéŸàŸéÿßÿ™' },
            allah: { name: 'Relationship with Allah', nameAr: 'ÿßŸÑŸÑŸá' },
            emotional: { name: 'Emotional Control', nameAr: 'ÿßŸÑÿ≠ŸéÿßŸÑŸéÿßÿ™ ÿßŸÑŸÜŸéŸëŸÅŸíÿ≥ŸêŸäŸéŸëÿ©' }
        };

        // State
        let currentPhase = 'welcome';
        let phase1Index = 0;
        let phase1Answers = {};
        let phase2Answers = {};
        let flaggedCategories = [];

        function startAssessment() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('phase1-screen').classList.remove('hidden');
            currentPhase = 'phase1';
            renderPhase1();
        }

        function renderPhase1() {
            const question = PHASE1_QUESTIONS[phase1Index];
            const questionNumber = phase1Index + 1;
            
            let html = `
                <div class="question">
                    <div class="question-text">
                        <span class="question-number">${questionNumber}</span>
                        <strong>Scenario:</strong>
                    </div>
                    <div class="scenario">${question.scenario}</div>
                    <div class="options" id="options-container">
            `;
            
            question.options.forEach((opt, idx) => {
                const selected = phase1Answers[question.id] === idx ? 'selected' : '';
                html += `
                    <div class="option ${selected}" onclick="selectOption(${idx})">
                        <span class="option-letter">${opt.letter}</span>
                        <span>${opt.text}</span>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('questions-phase1').innerHTML = html;
            updateProgressPhase1();
            updateNavigationPhase1();
        }

        function selectOption(index) {
            const question = PHASE1_QUESTIONS[phase1Index];
            phase1Answers[question.id] = index;
            renderPhase1();
            document.getElementById('next-btn-phase1').disabled = false;
        }

        function updateProgressPhase1() {
            const progress = ((phase1Index + 1) / 18) * 100;
            document.getElementById('progress-bar-phase1').style.width = progress + '%';
            document.getElementById('progress-text-phase1').textContent = `Question ${phase1Index + 1} of 18`;
        }

        function updateNavigationPhase1() {
            document.getElementById('back-btn-phase1').style.display = phase1Index > 0 ? 'inline-block' : 'none';
            document.getElementById('next-btn-phase1').disabled = phase1Answers[PHASE1_QUESTIONS[phase1Index].id] === undefined;
        }

        function nextPhase1() {
            if (phase1Index < 17) {
                phase1Index++;
                renderPhase1();
            } else {
                analyzePhase1();
            }
        }

        function goBackPhase1() {
            if (phase1Index > 0) {
                phase1Index--;
                renderPhase1();
            }
        }

        function analyzePhase1() {
            // Calculate category scores
            const categoryScores = {};
            
            PHASE1_QUESTIONS.forEach(q => {
                if (!categoryScores[q.category]) categoryScores[q.category] = 0;
                const answerIndex = phase1Answers[q.id];
                if (answerIndex !== undefined) {
                    categoryScores[q.category] += q.options[answerIndex].score;
                }
            });
            
            // Flag categories with score >= 6
            flaggedCategories = [];
            for (let cat in categoryScores) {
                if (categoryScores[cat] >= 6) {
                    flaggedCategories.push(cat);
                }
            }
            
            if (flaggedCategories.length === 0) {
                showResults();
            } else {
                showTransition();
            }
        }

        function showTransition() {
            document.getElementById('phase1-screen').classList.add('hidden');
            document.getElementById('transition-screen').classList.remove('hidden');
            
            let html = '';
            flaggedCategories.forEach(cat => {
                html += `<div class="flagged-category-badge">${CATEGORIES[cat].name}</div>`;
            });
            document.getElementById('flagged-list').innerHTML = html;
        }

        function startPhase2() {
            alert('Phase 2 will be fully implemented in the next iteration. For now, proceeding to results...');
            showResults();
        }

        function goBackPhase2() {
            // Implement phase 2 navigation
        }

        function nextPhase2() {
            // Implement phase 2 progression
        }

        function showResults() {
            document.getElementById('phase1-screen').classList.add('hidden');
            document.getElementById('transition-screen').classList.add('hidden');
            document.getElementById('phase2-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');

            // Calculate scores
            const categoryScores = {};
            let totalScore = 0;
            let categoryCount = 0;

            PHASE1_QUESTIONS.forEach(q => {
                if (!categoryScores[q.category]) {
                    categoryScores[q.category] = { total: 0, count: 0, max: 0 };
                }
                const answerIndex = phase1Answers[q.id];
                if (answerIndex !== undefined) {
                    categoryScores[q.category].total += q.options[answerIndex].score;
                    categoryScores[q.category].count++;
                    categoryScores[q.category].max += 4; // Max score per question
                }
            });

            for (let cat in categoryScores) {
                const percentage = (categoryScores[cat].total / categoryScores[cat].max) * 100;
                categoryScores[cat].percentage = percentage;
                totalScore += percentage;
                categoryCount++;
            }

            const overallHealth = 100 - (totalScore / categoryCount);

            // Display overall score
            document.getElementById('overall-score').textContent = Math.round(overallHealth) + '%';
            
            let healthDesc = '';
            let emoji = '';
            if (overallHealth >= 75) {
                healthDesc = 'Excellent - Your heart is in a sound state (ŸÇŸéŸÑŸíÿ® ÿ≥ŸéŸÑŸêŸäŸÖ)';
                emoji = 'üíö';
            } else if (overallHealth >= 50) {
                healthDesc = 'Good - Your heart is generally healthy but needs attention in some areas';
                emoji = 'üíõ';
            } else if (overallHealth >= 25) {
                healthDesc = 'Concerning - Your heart needs immediate care and treatment';
                emoji = 'üß°';
            } else {
                healthDesc = 'Critical - Your heart is in urgent need of purification';
                emoji = '‚ù§Ô∏è';
            }
            
            document.querySelector('.heart-icon').textContent = emoji;
            document.getElementById('health-description').textContent = healthDesc;

            // Display category breakdown
            let categoriesHTML = '';
            for (let cat in categoryScores) {
                const healthPercent = 100 - categoryScores[cat].percentage;
                const catData = CATEGORIES[cat];
                
                let status = '';
                let statusClass = '';
                if (healthPercent >= 75) {
                    status = 'Excellent';
                    statusClass = 'status-excellent';
                } else if (healthPercent >= 50) {
                    status = 'Good';
                    statusClass = 'status-good';
                } else if (healthPercent >= 25) {
                    status = 'Concerning';
                    statusClass = 'status-concerning';
                } else {
                    status = 'Critical';
                    statusClass = 'status-critical';
                }

                categoriesHTML += `
                    <div class="category-card">
                        <div class="category-name">${catData.name}</div>
                        <div style="color: var(--gold); font-size: 0.95rem; margin-bottom: 10px;">${catData.nameAr}</div>
                        <div class="category-score" style="color: ${healthPercent >= 50 ? 'var(--success)' : healthPercent >= 25 ? 'var(--warning)' : 'var(--danger)'}">
                            ${Math.round(healthPercent)}%
                        </div>
                        <div class="category-status ${statusClass}">${status}</div>
                    </div>
                `;
            }
            document.getElementById('categories-results').innerHTML = categoriesHTML;

            // Generate prescriptions (simplified for now)
            document.getElementById('prescriptions-container').innerHTML = `
                <p style="text-align: center; color: var(--text-light); font-size: 1.1rem;">
                    Detailed prescriptions based on Phase 2 assessment will be generated in the next iteration.<br>
                    For now, focus on the categories marked as "Concerning" or "Critical" above.
                </p>
            `;
        }

        function retakeAssessment() {
            phase1Index = 0;
            phase1Answers = {};
            phase2Answers = {};
            flaggedCategories = [];
            
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('welcome-screen').classList.remove('hidden');
        }

        function saveResults() {
            const timestamp = new Date().toISOString();
            const results = {
                timestamp,
                phase1Answers,
                phase2Answers
            };
            
            const hash = btoa(timestamp).substring(0, 10);
            localStorage.setItem(`qalb_${hash}`, JSON.stringify(results));
            
            alert(`Results saved! Your unique code is: ${hash}\n\nYou can retake this assessment anytime to track your progress.`);
        }

        // ========================================
        // PWA SERVICE WORKER REGISTRATION
        // ========================================
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered!', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }

        // ========================================
        // PWA INSTALL PROMPT
        // ========================================
        
        let deferredInstallPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üíæ Install prompt ready');
            e.preventDefault();
            deferredInstallPrompt = e;
            
            // Show custom install banner
            document.getElementById('install-banner').style.display = 'block';
        });

        function installPWA() {
            if (deferredInstallPrompt) {
                deferredInstallPrompt.prompt();
                
                deferredInstallPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ User accepted the install');
                    } else {
                        console.log('‚ùå User dismissed the install');
                    }
                    deferredInstallPrompt = null;
                    dismissInstallBanner();
                });
            }
        }

        function dismissInstallBanner() {
            document.getElementById('install-banner').style.display = 'none';
        }

        // Check if app is installed
        window.addEventListener('appinstalled', (e) => {
            console.log('üéâ PWA was installed successfully!');
            dismissInstallBanner();
        });

        // Check if running as PWA
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
            console.log('üì± Running as installed PWA!');
        }
    </script>
</body>
</html>
